I"°¿<h3 id="æ¦‚è¿°">æ¦‚è¿°</h3>

<p>æœ¬ç¯‡æ–‡ç« åˆ†æMyBatis çš„è§£æå™¨æ¨¡å—ï¼Œå¯¹åº”<code class="highlighter-rouge">org.apache.ibatis.parsing</code>åŒ…å½“ä¸­çš„ä¸€äº›ä¸œè¥¿</p>

<p><img src="http://image.augustrush8.com/images/mybatis/parsing.JPG" alt="" /></p>

<p>å‰ä¸€ç¯‡æ–‡ç« å½“ä¸­å·²ç»è¯´æ˜äº†å®ƒçš„ä½œç”¨ï¼Œè¿™é‡Œå†æ¥å›çœ‹ä¸€ä¸‹</p>

<p>è§£æå™¨æ¨¡å—ï¼Œä¸»è¦æä¾›äº†ä¸¤ä¸ªåŠŸèƒ½:</p>

<ul>
  <li>ä¸€ä¸ªåŠŸèƒ½ï¼Œæ˜¯å¯¹ <a href="http://www.w3school.com.cn/xpath/index.asp">XPath</a> è¿›è¡Œå°è£…ï¼Œä¸º MyBatis åˆå§‹åŒ–æ—¶è§£æ <code class="highlighter-rouge">mybatis-config.xml</code> é…ç½®æ–‡ä»¶ä»¥åŠæ˜ å°„é…ç½®æ–‡ä»¶æä¾›æ”¯æŒã€‚</li>
  <li>å¦ä¸€ä¸ªåŠŸèƒ½ï¼Œæ˜¯ä¸ºå¤„ç†åŠ¨æ€ SQL è¯­å¥ä¸­çš„å ä½ç¬¦æä¾›æ”¯æŒã€‚</li>
</ul>

<h4 id="xpathparser">XPathParser</h4>

<p><code class="highlighter-rouge">org.apache.ibatis.parsing.XPathParser</code>ç±»ï¼ŒåŸºäº Java <strong>XPath</strong> è§£æå™¨ï¼Œç”¨äºè§£æ MyBatis <code class="highlighter-rouge">mybatis-config.xml</code>å’Œ <code class="highlighter-rouge">**Mapper.xml</code> ç­‰ XML é…ç½®æ–‡ä»¶ã€‚å±æ€§å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">final</span> <span class="nc">Document</span> <span class="n">document</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">validation</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">EntityResolver</span> <span class="n">entityResolver</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">Properties</span> <span class="n">variables</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">XPath</span> <span class="n">xpath</span><span class="o">;</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>document
</code></pre></div></div>

<p>å±æ€§ï¼ŒXML è¢«è§£æåï¼Œç”Ÿæˆçš„</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>org.w3c.dom.Document
</code></pre></div></div>

<p>å¯¹è±¡ã€‚</p>

<ul>
  <li><code class="highlighter-rouge">validation</code> å±æ€§ï¼Œæ˜¯å¦æ ¡éªŒ XML ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå€¼ä¸º <code class="highlighter-rouge">true</code> ã€‚</li>
  <li><code class="highlighter-rouge">entityResolver</code> å±æ€§ï¼Œ<code class="highlighter-rouge">org.xml.sax.EntityResolver</code> å¯¹è±¡ï¼ŒXML å®ä½“è§£æå™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹ XML è¿›è¡Œæ ¡éªŒæ—¶ï¼Œä¼šåŸºäº XML æ–‡æ¡£å¼€å§‹ä½ç½®æŒ‡å®šçš„ DTD æ–‡ä»¶æˆ– XSD æ–‡ä»¶ã€‚ä¾‹å¦‚è¯´ï¼Œè§£æ <code class="highlighter-rouge">mybatis-config.xml</code> é…ç½®æ–‡ä»¶æ—¶ï¼Œä¼šåŠ è½½ <code class="highlighter-rouge">http://mybatis.org/dtd/mybatis-3-config.dtd</code> è¿™ä¸ª DTD æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ¯ä¸ªåº”ç”¨å¯åŠ¨éƒ½ä»ç½‘ç»œåŠ è½½è¯¥ DTD æ–‡ä»¶ï¼ŒåŠ¿å¿…åœ¨å¼±ç½‘ç»œä¸‹ä½“éªŒéå¸¸ä¸‹ï¼Œç”šè‡³è¯´åº”ç”¨éƒ¨ç½²åœ¨æ— ç½‘ç»œçš„ç¯å¢ƒä¸‹ï¼Œè¿˜ä¼šå¯¼è‡´ä¸‹è½½ä¸ä¸‹æ¥ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç° XML æ ¡éªŒå¤±è´¥çš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œåœ¨å®é™…åœºæ™¯ä¸‹ï¼ŒMyBatis è‡ªå®šä¹‰äº† EntityResolver çš„å®ç°ï¼Œè¾¾åˆ°ä½¿ç”¨<strong>æœ¬åœ°</strong> DTD æ–‡ä»¶ï¼Œä»è€Œé¿å…ä¸‹è½½<strong>ç½‘ç»œ</strong> DTD æ–‡ä»¶çš„æ•ˆæœã€‚</li>
  <li><code class="highlighter-rouge">xpath</code> å±æ€§ï¼Œ<code class="highlighter-rouge">javax.xml.xpath.XPath</code> å¯¹è±¡ï¼Œç”¨äºæŸ¥è¯¢ XML ä¸­çš„èŠ‚ç‚¹å’Œå…ƒç´ ã€‚</li>
  <li><code class="highlighter-rouge">variables</code> å±æ€§ï¼Œå˜é‡ Properties å¯¹è±¡ï¼Œç”¨æ¥æ›¿æ¢éœ€è¦åŠ¨æ€é…ç½®çš„å±æ€§å€¼ã€‚ä¾‹å¦‚ï¼š</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dataSource</span> <span class="na">type=</span><span class="s">"POOLED"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driver"</span> <span class="na">value=</span><span class="s">"${driver}"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"${url}"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"${username}"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${password}"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/dataSource&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">variables</code> çš„æ¥æºï¼Œå³å¯ä»¥åœ¨å¸¸ç”¨çš„ Java Properties æ–‡ä»¶ä¸­é…ç½®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ MyBatis <code class="highlighter-rouge">&lt;property /&gt;</code> æ ‡ç­¾ä¸­é…ç½®ã€‚ä¾‹å¦‚ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;properties</span> <span class="na">resource=</span><span class="s">"org/mybatis/example/config.properties"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"dev_user"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"F2Fa3!33TYyg"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
</code></pre></div></div>

<p>è¿™é‡Œé…ç½®çš„ <code class="highlighter-rouge">username</code> å’Œ <code class="highlighter-rouge">password</code> å±æ€§ï¼Œå°±å¯ä»¥æ›¿æ¢ä¸Šé¢çš„ <code class="highlighter-rouge">${username}</code> å’Œ <code class="highlighter-rouge">${password}</code> è¿™ä¸¤ä¸ªåŠ¨æ€å±æ€§ã€‚</p>

<h5 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h5>

<p>XPathParser çš„æ„é€ æ–¹æ³•æœ‰16ä¸ªï¼Œæˆ‘ä»¬æŒ‘é€‰å…¶ä¸­ä¸€ä¸ªä½œåˆ†æ</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æ„é€  XPathParser å¯¹è±¡
 *
 * @param xml XML æ–‡ä»¶åœ°å€
 * @param validation æ˜¯å¦æ ¡éªŒ XML
 * @param variables å˜é‡ Properties å¯¹è±¡
 * @param entityResolver XML å®ä½“è§£æå™¨
 */</span>
<span class="kd">public</span> <span class="nf">XPathParser</span><span class="o">(</span><span class="nc">String</span> <span class="n">xml</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">validation</span><span class="o">,</span> <span class="nc">Properties</span> <span class="n">variables</span><span class="o">,</span> <span class="nc">EntityResolver</span> <span class="n">entityResolver</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">commonConstructor</span><span class="o">(</span><span class="n">validation</span><span class="o">,</span> <span class="n">variables</span><span class="o">,</span> <span class="n">entityResolver</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">document</span> <span class="o">=</span> <span class="n">createDocument</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringReader</span><span class="o">(</span><span class="n">xml</span><span class="o">)));</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>å…¬ç”¨çš„æ„é€ æ–¹æ³•<code class="highlighter-rouge">commonConstructor</code>é€»è¾‘å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">commonConstructor</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">validation</span><span class="o">,</span> <span class="nc">Properties</span> <span class="n">variables</span><span class="o">,</span> <span class="nc">EntityResolver</span> <span class="n">entityResolver</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">validation</span> <span class="o">=</span> <span class="n">validation</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">entityResolver</span> <span class="o">=</span> <span class="n">entityResolver</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">variables</span> <span class="o">=</span> <span class="n">variables</span><span class="o">;</span>
    <span class="nc">XPathFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">XPathFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">xpath</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newXPath</span><span class="o">();</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>æ–¹æ³•<code class="highlighter-rouge">createDocument</code>é€»è¾‘å¦‚ä¸‹ï¼Œå³å®Œæˆxmlæ–‡ä»¶åˆ°Documentå¯¹è±¡ä¹‹é—´çš„è½¬åŒ–</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
   * åˆ›å»º Document å¯¹è±¡
   *
   * @param inputSource XML çš„ InputSource å¯¹è±¡
   * @return Document å¯¹è±¡
   */</span>
  <span class="kd">private</span> <span class="nc">Document</span> <span class="nf">createDocument</span><span class="o">(</span><span class="nc">InputSource</span> <span class="n">inputSource</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// important: this must only be called AFTER common constructor</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 1&gt; åˆ›å»º DocumentBuilderFactory å¯¹è±¡</span>
      <span class="nc">DocumentBuilderFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="nc">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
      <span class="n">factory</span><span class="o">.</span><span class="na">setValidating</span><span class="o">(</span><span class="n">validation</span><span class="o">);</span><span class="c1">// è®¾ç½®æ˜¯å¦éªŒè¯ XML</span>

      <span class="n">factory</span><span class="o">.</span><span class="na">setNamespaceAware</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
      <span class="n">factory</span><span class="o">.</span><span class="na">setIgnoringComments</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">factory</span><span class="o">.</span><span class="na">setIgnoringElementContentWhitespace</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
      <span class="n">factory</span><span class="o">.</span><span class="na">setCoalescing</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
      <span class="n">factory</span><span class="o">.</span><span class="na">setExpandEntityReferences</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="c1">// 2&gt; åˆ›å»º DocumentBuilder å¯¹è±¡</span>
      <span class="nc">DocumentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">setEntityResolver</span><span class="o">(</span><span class="n">entityResolver</span><span class="o">);</span><span class="c1">// è®¾ç½®å®ä½“è§£æå™¨</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">setErrorHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ErrorHandler</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">error</span><span class="o">(</span><span class="nc">SAXParseException</span> <span class="n">exception</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SAXException</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">exception</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fatalError</span><span class="o">(</span><span class="nc">SAXParseException</span> <span class="n">exception</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SAXException</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">exception</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">warning</span><span class="o">(</span><span class="nc">SAXParseException</span> <span class="n">exception</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">SAXException</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">});</span>
      <span class="c1">// 3&gt; è§£æ XML æ–‡ä»¶</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">inputSource</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BuilderException</span><span class="o">(</span><span class="s">"Error creating document instance.  Cause: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<h5 id="evalæ–¹æ³•æ—">evalæ–¹æ³•æ—</h5>

<p>XPathParser ç±»æä¾›äº†ä¸€ç³»åˆ—çš„ <code class="highlighter-rouge">eval*</code> æ–¹æ³•ï¼Œç”¨äºè·å¾— Booleanã€Shortã€Integerã€Longã€Floatã€Doubleã€Stringã€Node ç±»å‹çš„å…ƒç´ æˆ–èŠ‚ç‚¹çš„â€œå€¼â€ã€‚å½“ç„¶ï¼Œè™½ç„¶æ–¹æ³•å¾ˆå¤šï¼Œä½†æ˜¯éƒ½æ˜¯åŸºäº <code class="highlighter-rouge">evaluate(String expression, Object root, QName returnType)</code> æ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
   * è·å¾—æŒ‡å®šå…ƒç´ æˆ–èŠ‚ç‚¹çš„å€¼
   * @param expression
   * @param root æŒ‡å®šèŠ‚ç‚¹
   * @param returnType è¿”å›å€¼ç±»å‹
   * @return å€¼
   */</span>
  <span class="kd">private</span> <span class="nc">Object</span> <span class="nf">evaluate</span><span class="o">(</span><span class="nc">String</span> <span class="n">expression</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">root</span><span class="o">,</span> <span class="nc">QName</span> <span class="n">returnType</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">xpath</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">expression</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="n">returnType</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">BuilderException</span><span class="o">(</span><span class="s">"Error evaluating XPath.  Cause: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨ <code class="highlighter-rouge">xpath</code> çš„ <code class="highlighter-rouge">evaluate(String expression, Object root, QName returnType)</code> æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šå…ƒç´ æˆ–èŠ‚ç‚¹çš„å€¼ã€‚</p>

<ul>
  <li>evalå…ƒç´ </li>
</ul>

<p>eval å…ƒç´ çš„æ–¹æ³•ï¼Œç”¨äºè·å¾— Booleanã€Shortã€Integerã€Longã€Floatã€Doubleã€String ç±»å‹çš„<strong>å…ƒç´ </strong>çš„å€¼ã€‚æˆ‘ä»¬ä»¥ <code class="highlighter-rouge">evalString(Object root, String expression)</code> æ–¹æ³•ä¸ºä¾‹å­ï¼Œçœ‹çœ‹ä»£ç ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
   * è§£æè·å¾—å…ƒç´ çš„å€¼
   * @param root
   * @param expression
   * @return
   */</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">evalString</span><span class="o">(</span><span class="nc">Object</span> <span class="n">root</span><span class="o">,</span> <span class="nc">String</span> <span class="n">expression</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// &lt;1&gt; è·å¾—å€¼</span>
    <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">evaluate</span><span class="o">(</span><span class="n">expression</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="nc">XPathConstants</span><span class="o">.</span><span class="na">STRING</span><span class="o">);</span>
    <span class="c1">// &lt;2&gt; åŸºäº variables æ›¿æ¢åŠ¨æ€å€¼ï¼Œå¦‚æœ result ä¸ºåŠ¨æ€å€¼</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nc">PropertyParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">variables</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div></div>

<p><strong>1.</strong><code class="highlighter-rouge">&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code class="highlighter-rouge">#evaluate(String expression, Object root, QName returnType)</code> æ–¹æ³•ï¼Œè·å¾—å€¼ã€‚å…¶ä¸­ï¼Œ<code class="highlighter-rouge">returnType</code> æ–¹æ³•ä¼ å…¥çš„æ˜¯ <code class="highlighter-rouge">XPathConstants.STRING</code> ï¼Œè¡¨ç¤ºè¿”å›çš„å€¼æ˜¯ String ç±»å‹ã€‚</p>

<p><strong>2.</strong> <code class="highlighter-rouge">&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code class="highlighter-rouge">PropertyParser#parse(String string, Properties variables)</code> æ–¹æ³•ï¼ŒåŸºäº <code class="highlighter-rouge">variables</code> æ›¿æ¢<strong>åŠ¨æ€å€¼</strong>ï¼Œå¦‚æœ <code class="highlighter-rouge">result</code> ä¸º<strong>åŠ¨æ€å€¼</strong>ã€‚<strong>è¿™å°±æ˜¯ MyBatis å¦‚ä½•æ›¿æ¢æ‰ XML ä¸­çš„åŠ¨æ€å€¼å®ç°çš„æ–¹å¼ã€‚</strong></p>

<ul>
  <li>evalèŠ‚ç‚¹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">XNode</span><span class="o">&gt;</span> <span class="nf">evalNodes</span><span class="o">(</span><span class="nc">String</span> <span class="n">expression</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">evalNodes</span><span class="o">(</span><span class="n">document</span><span class="o">,</span> <span class="n">expression</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">XNode</span><span class="o">&gt;</span> <span class="nf">evalNodes</span><span class="o">(</span><span class="nc">Object</span> <span class="n">root</span><span class="o">,</span> <span class="nc">String</span> <span class="n">expression</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">XNode</span><span class="o">&gt;</span> <span class="n">xnodes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// &lt;1&gt; è·å¾— Node æ•°ç»„</span>
    <span class="nc">NodeList</span> <span class="n">nodes</span> <span class="o">=</span> <span class="o">(</span><span class="nc">NodeList</span><span class="o">)</span> <span class="n">evaluate</span><span class="o">(</span><span class="n">expression</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="nc">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>
    <span class="c1">// &lt;2&gt; å°è£…æˆ XNode æ•°ç»„</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">xnodes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">XNode</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">nodes</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="n">variables</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">xnodes</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">XNode</span> <span class="nf">evalNode</span><span class="o">(</span><span class="nc">String</span> <span class="n">expression</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">evalNode</span><span class="o">(</span><span class="n">document</span><span class="o">,</span> <span class="n">expression</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">XNode</span> <span class="nf">evalNode</span><span class="o">(</span><span class="nc">Object</span> <span class="n">root</span><span class="o">,</span> <span class="nc">String</span> <span class="n">expression</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">)</span> <span class="n">evaluate</span><span class="o">(</span><span class="n">expression</span><span class="o">,</span> <span class="n">root</span><span class="o">,</span> <span class="nc">XPathConstants</span><span class="o">.</span><span class="na">NODE</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">XNode</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">node</span><span class="o">,</span> <span class="n">variables</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>1.<code class="highlighter-rouge">&lt;1&gt;</code> å¤„ï¼Œè¿”å›ç»“æœæœ‰ Node <strong>å¯¹è±¡</strong>å’Œ<strong>æ•°ç»„</strong>ä¸¤ç§æƒ…å†µï¼Œæ ¹æ®æ–¹æ³•å‚æ•° <code class="highlighter-rouge">expression</code> éœ€è¦è·å–çš„èŠ‚ç‚¹ä¸åŒã€‚</p>

<p>2.<code class="highlighter-rouge">&lt;2&gt;</code> å¤„ï¼Œ æœ€ç»ˆç»“æœä¼šå°† Node å°è£…æˆ <code class="highlighter-rouge">org.apache.ibatis.parsing.XNode</code> å¯¹è±¡ï¼Œä¸»è¦ä¸ºäº†<strong>åŠ¨æ€å€¼çš„æ›¿æ¢</strong></p>

<h4 id="generictokenparser">GenericTokenParser</h4>

<p><strong>é€šç”¨</strong>çš„ Token è§£æå™¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GenericTokenParser</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">openToken</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">closeToken</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TokenHandler</span> <span class="n">handler</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">GenericTokenParser</span><span class="o">(</span><span class="nc">String</span> <span class="n">openToken</span><span class="o">,</span> <span class="nc">String</span> <span class="n">closeToken</span><span class="o">,</span> <span class="nc">TokenHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">openToken</span> <span class="o">=</span> <span class="n">openToken</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">closeToken</span> <span class="o">=</span> <span class="n">closeToken</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">text</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">text</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">""</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// search open token</span>
    <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">openToken</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">text</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kt">char</span><span class="o">[]</span> <span class="n">src</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
    <span class="nc">StringBuilder</span> <span class="n">expression</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">src</span><span class="o">[</span><span class="n">start</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="sc">'\\'</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// this open token is escaped. remove the backslash and continue.</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">start</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">openToken</span><span class="o">);</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">openToken</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// found open token. let's search close token.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">expression</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">expression</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">expression</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">start</span> <span class="o">-</span> <span class="n">offset</span><span class="o">);</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">openToken</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">closeToken</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">src</span><span class="o">[</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="sc">'\\'</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// this close token is escaped. remove the backslash and continue.</span>
            <span class="n">expression</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">closeToken</span><span class="o">);</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">closeToken</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">closeToken</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">expression</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">offset</span><span class="o">);</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">closeToken</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// close token was not found.</span>
          <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">start</span><span class="o">,</span> <span class="n">src</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
          <span class="n">offset</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">handler</span><span class="o">.</span><span class="na">handleToken</span><span class="o">(</span><span class="n">expression</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
          <span class="n">offset</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="n">closeToken</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">start</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">openToken</span><span class="o">,</span> <span class="n">offset</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">src</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">src</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">src</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="n">offset</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ä»£ç çœ‹èµ·æ¥å¥½å†—é•¿ï¼Œä½†æ˜¯æ·¡å®šï¼Œå°±ä¸€ä¸ª <code class="highlighter-rouge">parse(String text)</code> æ–¹æ³•ï¼Œ<strong>å¾ªç¯</strong>( å› ä¸ºå¯èƒ½ä¸åªä¸€ä¸ª )ï¼Œè§£æä»¥ <code class="highlighter-rouge">openToken</code> å¼€å§‹ï¼Œä»¥ <code class="highlighter-rouge">closeToken</code> ç»“æŸçš„ Token ï¼Œå¹¶æäº¤ç»™ <code class="highlighter-rouge">handler</code> è¿›è¡Œå¤„ç†</p>

<h4 id="propertyparser">PropertyParser</h4>

<p>åŠ¨æ€å±æ€§è§£æå™¨ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">parse</span><span class="o">(</span><span class="nc">String</span> <span class="n">string</span><span class="o">,</span> <span class="nc">Properties</span> <span class="n">variables</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">VariableTokenHandler</span> <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">VariableTokenHandler</span><span class="o">(</span><span class="n">variables</span><span class="o">);</span>
    <span class="nc">GenericTokenParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericTokenParser</span><span class="o">(</span><span class="s">"${"</span><span class="o">,</span> <span class="s">"}"</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">string</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>å…³é”®çœ‹çœ‹ä¸Šé¢è¿™ä¸ªç±»æ–¹æ³•ï¼Œç”±æ­¤å¯ä»¥å¾—çŸ¥ï¼Œæ­¤ç±»æ–¹æ³•ä¸»è¦é’ˆå¯¹XMLå½“ä¸­çš„<code class="highlighter-rouge">${name}</code>å’Œ<code class="highlighter-rouge">${password}</code>åŠ¨æ€å€¼è¿›è¡Œèµ‹å€¼è§£æã€‚</p>

<h4 id="tokenhandler">TokenHandler</h4>

<p>Token å¤„ç†å™¨æ¥å£</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TokenHandler</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">handleToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªæ¥å£çš„ç»§æ‰¿ç±»</p>

<p><img src="http://image.augustrush8.com/images/mybatis/tokenhandler.JPG" alt="" /></p>

<p>å†<code class="highlighter-rouge">parsing</code>è¿™ä¸ªåŒ…å½“ä¸­æˆ‘ä»¬å·²ç»åœ¨<code class="highlighter-rouge">PropertyParser</code>è¿™ä¸ªç±»ä¸­ç”¨åˆ°äº†<code class="highlighter-rouge">VariableTokenHandler</code>,<code class="highlighter-rouge">VariableTokenHandler</code>æ˜¯<code class="highlighter-rouge">PropertyParser</code>çš„é™æ€å†…éƒ¨ç±»ã€‚</p>

<h4 id="variabletokenhandler">VariableTokenHandler</h4>

<ul>
  <li>æ„é€ æ–¹æ³•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">VariableTokenHandler</span> <span class="kd">implements</span> <span class="nc">TokenHandler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Properties</span> <span class="n">variables</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">enableDefaultValue</span><span class="o">;</span><span class="c1">//æ˜¯å¦å¼€å¯é»˜è®¤å€¼åŠŸèƒ½ã€‚é»˜è®¤ä¸º {@link #ENABLE_DEFAULT_VALUE}</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">defaultValueSeparator</span><span class="o">;</span><span class="c1">//é»˜è®¤å€¼çš„åˆ†éš”ç¬¦ã€‚é»˜è®¤ä¸º {@link #KEY_DEFAULT_VALUE_SEPARATOR} ï¼Œå³ ":" ã€‚</span>

    <span class="kd">private</span> <span class="nf">VariableTokenHandler</span><span class="o">(</span><span class="nc">Properties</span> <span class="n">variables</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">variables</span> <span class="o">=</span> <span class="n">variables</span><span class="o">;</span>
      <span class="k">this</span><span class="o">.</span><span class="na">enableDefaultValue</span> <span class="o">=</span> <span class="nc">Boolean</span><span class="o">.</span><span class="na">parseBoolean</span><span class="o">(</span><span class="n">getPropertyValue</span><span class="o">(</span><span class="no">KEY_ENABLE_DEFAULT_VALUE</span><span class="o">,</span> <span class="no">ENABLE_DEFAULT_VALUE</span><span class="o">));</span>
      <span class="k">this</span><span class="o">.</span><span class="na">defaultValueSeparator</span> <span class="o">=</span> <span class="n">getPropertyValue</span><span class="o">(</span><span class="no">KEY_DEFAULT_VALUE_SEPARATOR</span><span class="o">,</span> <span class="no">DEFAULT_VALUE_SEPARATOR</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getPropertyValue</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">String</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">variables</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">defaultValue</span> <span class="o">:</span> <span class="n">variables</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>1.<code class="highlighter-rouge">variables</code> å±æ€§ï¼Œå˜é‡ Properties å¯¹è±¡ã€‚</p>

<p>2.<code class="highlighter-rouge">enableDefaultValue</code> å±æ€§ï¼Œæ˜¯å¦å¼€å¯é»˜è®¤å€¼åŠŸèƒ½ã€‚é»˜è®¤ä¸º <code class="highlighter-rouge">ENABLE_DEFAULT_VALUE</code> ï¼Œå³<strong>ä¸å¼€å¯</strong>ã€‚æƒ³è¦å¼€å¯ï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;properties</span> <span class="na">resource=</span><span class="s">"org/mybatis/example/config.properties"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"org.apache.ibatis.parsing.PropertyParser.enable-default-value"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- Enable this feature --&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">defaultValueSeparator</code> å±æ€§ï¼Œé»˜è®¤å€¼çš„åˆ†éš”ç¬¦ã€‚é»˜è®¤ä¸º <code class="highlighter-rouge">KEY_DEFAULT_VALUE_SEPARATOR</code> ï¼Œå³ <code class="highlighter-rouge">":"</code> ã€‚æƒ³è¦ä¿®æ”¹ï¼Œå¯ä»¥é…ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;properties</span> <span class="na">resource=</span><span class="s">"org/mybatis/example/config.properties"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"org.apache.ibatis.parsing.PropertyParser.default-value-separator"</span> <span class="na">value=</span><span class="s">"?:"</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- Change default value of separator --&gt;</span>
<span class="nt">&lt;/properties&gt;</span>
</code></pre></div></div>

<ul>
  <li>handleTokenæ–¹æ³•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">String</span> <span class="nf">handleToken</span><span class="o">(</span><span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">variables</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
        <span class="c1">// å¼€å¯é»˜è®¤å€¼åŠŸèƒ½</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">enableDefaultValue</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// æŸ¥æ‰¾é»˜è®¤å€¼</span>
          <span class="kd">final</span> <span class="kt">int</span> <span class="n">separatorIndex</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="n">defaultValueSeparator</span><span class="o">);</span>
          <span class="nc">String</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">separatorIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">separatorIndex</span><span class="o">);</span>
            <span class="n">defaultValue</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">separatorIndex</span> <span class="o">+</span> <span class="n">defaultValueSeparator</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="c1">// æœ‰é»˜è®¤å€¼ï¼Œä¼˜å…ˆæ›¿æ¢ï¼Œä¸å­˜åœ¨åˆ™è¿”å›é»˜è®¤å€¼</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">defaultValue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">variables</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// æœªå¼€å¯é»˜è®¤å€¼åŠŸèƒ½ï¼Œç›´æ¥æ›¿æ¢</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">variables</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">variables</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="c1">// æ—  variables ï¼Œç›´æ¥è¿”å›</span>
      <span class="k">return</span> <span class="s">"${"</span> <span class="o">+</span> <span class="n">content</span> <span class="o">+</span> <span class="s">"}"</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

:ET