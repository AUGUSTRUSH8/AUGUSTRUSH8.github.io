I"¶J<h3 id="å®‰è£…">å®‰è£…</h3>

<h4 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h4>

<ul>
  <li><a href="http://blog.51cto.com/xinzong/1834466">åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ-FastDFS</a></li>
  <li><a href="http://blog.51cto.com/oldcat1981/1766810">ä½¿ç”¨FastDFSæ­å»ºå›¾ç‰‡æœåŠ¡å™¨å•å®ä¾‹ç¯‡</a></li>
  <li><a href="https://www.cnblogs.com/moxiaoan/p/5683743.html">CentOS7ä½¿ç”¨firewalldæ‰“å¼€å…³é—­é˜²ç«å¢™ä¸ç«¯å£</a></li>
</ul>

<h4 id="æœåŠ¡å™¨ç¯å¢ƒ">æœåŠ¡å™¨ç¯å¢ƒ</h4>

<ul>
  <li>CentOS7</li>
  <li>IP: 120.78.237.137</li>
</ul>

<h4 id="å®‰è£…åŸºæœ¬ç¯å¢ƒ">å®‰è£…åŸºæœ¬ç¯å¢ƒ</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum groupinstall <span class="s2">"Development Tools"</span> <span class="s2">"Server platform Development"</span>
</code></pre></div></div>

<h4 id="å®‰è£…-libfastcommon">å®‰è£… libfastcommon</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /usr/local/
git clone https://github.com/happyfish100/libfastcommon.git
<span class="nb">cd </span>libfastcommon/
./make.sh
./make.sh <span class="nb">install</span>
</code></pre></div></div>

<h4 id="å®‰è£…-fastdfs">å®‰è£… fastdfs</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /usr/local/
git clone https://github.com/happyfish100/fastdfs.git
<span class="nb">cd </span>fastdfs/
./make.sh
./make.sh <span class="nb">install</span>
</code></pre></div></div>

<h4 id="é…ç½®-tracker">é…ç½® tracker</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/fdfs
<span class="nb">cp </span>tracker.conf.sample tracker.conf
vim /etc/fdfs/tracker.conf

<span class="nv">disabled</span><span class="o">=</span><span class="nb">false</span>ï¼ˆé»˜è®¤ä¸ºfalseï¼Œè¡¨ç¤ºæ˜¯å¦æ— æ•ˆï¼‰
<span class="nv">port</span><span class="o">=</span>22122ï¼ˆé»˜è®¤ä¸º22122ï¼‰
<span class="nv">base_path</span><span class="o">=</span>/data/fdfs/tracker
</code></pre></div></div>

<h4 id="é…ç½®-clientconf">é…ç½® client.conf</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/fdfs
<span class="nb">cp </span>client.conf.sample client.conf
vim /etc/fdfs/client.conf

<span class="nv">base_path</span><span class="o">=</span>/data/fdfs/tracker
<span class="nv">tracker_server</span><span class="o">=</span>120.78.237.137:22122
</code></pre></div></div>

<h4 id="åˆ›å»º-tracker-ç›®å½•">åˆ›å»º tracker ç›®å½•</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-pv</span> /data/fdfs/tracker
</code></pre></div></div>

<h4 id="å¯åŠ¨-tracker">å¯åŠ¨ tracker</h4>

<ul>
  <li><em>centos7 å¯åŠ¨æ–¹å¼</em></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/fdfs_trackerd start
</code></pre></div></div>

<h4 id="æŸ¥çœ‹ç«¯å£">æŸ¥çœ‹ç«¯å£</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ss <span class="nt">-lntup</span>|grep 22122
tcp LISTEN 0 128 :22122 :<span class="k">*</span> <span class="nb">users</span>:<span class="o">((</span>â€œfdfs_trackerdâ€,3785,5<span class="o">))</span> 
</code></pre></div></div>

<h4 id="å…³é—­tracker">å…³é—­tracker</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/fdfs_trackerd stop
</code></pre></div></div>

<p><strong>æ³¨æ„ï¼šè™½ç„¶FastDFSåŒºåˆ†trackerå’ŒstorageæœåŠ¡å™¨ï¼Œä½†æ˜¯å®‰è£…çš„è½¯ä»¶åŠæ­¥éª¤å‡ç›¸åŒï¼Œåªæ˜¯ä¸åŒçš„é…ç½®æ–‡ä»¶è€Œå·²ï¼Œå› æ­¤ä»¥ä¸Šå®‰è£…é€‚ç”¨tracker serverå’Œstorage server</strong></p>

<h4 id="é…ç½®-storage">é…ç½® storage</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/fdfs
<span class="nb">cp </span>storage.conf.sample storage.conf
vim /etc/fdfs/storage.conf

<span class="nv">disabled</span><span class="o">=</span><span class="nb">false</span>ï¼ˆé»˜è®¤ä¸ºfalseï¼Œè¡¨ç¤ºæ˜¯å¦æ— æ•ˆï¼‰
<span class="nv">port</span><span class="o">=</span>23000ï¼ˆé»˜è®¤ä¸º23000ï¼‰
<span class="nv">group_name</span><span class="o">=</span>group1 <span class="c">#æŒ‡å®šç»„å</span>
<span class="nv">base_path</span><span class="o">=</span>/data/fdfs/storage <span class="c"># ç”¨äºå­˜å‚¨æ•°æ®</span>
<span class="nv">store_path_count</span><span class="o">=</span>2 <span class="c"># è®¾ç½®è®¾å¤‡æ•°é‡</span>
<span class="nv">store_path0</span><span class="o">=</span>/data/fdfs/storage/m0 <span class="c">#æŒ‡å®šå­˜å‚¨è·¯å¾„0</span>
<span class="nv">store_path1</span><span class="o">=</span>/data/fdfs/storage/m1 <span class="c">#æŒ‡å®šå­˜å‚¨è·¯å¾„1</span>
æ³¨æ„ï¼šåŒä¸€ç»„å†…å­˜å‚¨è·¯å¾„ä¸èƒ½å†²çªï¼Œä¾‹å¦‚ï¼šä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å­˜å‚¨è·¯å¾„å°±æ˜¯m2,m3â€¦.ç­‰
<span class="nv">tracker_server</span><span class="o">=</span>120.78.237.137:22122 <span class="c">#æŒ‡å®štracker</span>
http.server_port<span class="o">=</span>8888ï¼ˆé»˜è®¤ä¸º8888ï¼Œnginxä¸­é…ç½®çš„ç›‘å¬ç«¯å£é‚£ä¹‹ä¸€è‡´ï¼‰

<span class="nb">mkdir</span> <span class="nt">-pv</span> /data/fdfs/storage/<span class="o">{</span>m0,m1<span class="o">}</span> <span class="c"># åˆ›å»ºæ•°æ®ç›®å½•</span>
</code></pre></div></div>

<h4 id="å¯åŠ¨-storage">å¯åŠ¨ storage</h4>

<p><strong>å¿…é¡»å…ˆå¯åŠ¨trackerï¼Œå†å¯åŠ¨storage</strong></p>

<ul>
  <li>centos7 å¯åŠ¨æ–¹å¼</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/fdfs_storaged start
</code></pre></div></div>

<h4 id="æŸ¥çœ‹ç«¯å£-1">æŸ¥çœ‹ç«¯å£</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ss <span class="nt">-lntup</span>|grep 23000
LISTEN 0 128 :23000 :<span class="k">*</span> 
</code></pre></div></div>

<h4 id="å…³é—­storage">å…³é—­storage</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/fdfs_storaged stop
</code></pre></div></div>

<h4 id="æ–‡ä»¶ä¸Šä¼ æµ‹è¯•">æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h4>

<p><strong>springboot æµ‹è¯•æ–¹æ¡ˆ</strong></p>

<ul>
  <li>å¼•å…¥ä¾èµ–</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.github.tobato<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>fastdfs-client<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<ul>
  <li>ç¼–å†™é…ç½®ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">FdfsClientConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">// è§£å†³jmxé‡å¤æ³¨å†Œbeançš„é—®é¢˜</span>
<span class="nd">@EnableMBeanExport</span><span class="o">(</span><span class="n">registration</span><span class="o">=</span> <span class="nc">RegistrationPolicy</span><span class="o">.</span><span class="na">IGNORE_EXISTING</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FastClientImporter</span> <span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ç¼–å†™æµ‹è¯•ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="nc">LyUploadService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FdfsTest</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">FastFileStorageClient</span> <span class="n">storageClient</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">ThumbImageConfig</span> <span class="n">thumbImageConfig</span><span class="o">;</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUpload</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">FileNotFoundException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">file</span><span class="o">=</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"D:\\my_project\\idea_pro_inuse\\leyouUpload\\logo3.jpg"</span><span class="o">);</span>
        <span class="c1">//ä¸Šä¼ å¹¶ä¸”ç”Ÿæˆç¼©ç•¥å›¾</span>
        <span class="nc">StorePath</span> <span class="n">storePath</span><span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">storageClient</span><span class="o">.</span><span class="na">uploadFile</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">),</span><span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span><span class="s">"jpg"</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="c1">// å¸¦åˆ†ç»„çš„è·¯å¾„</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">storePath</span><span class="o">.</span><span class="na">getFullPath</span><span class="o">());</span>
        <span class="c1">// ä¸å¸¦åˆ†ç»„çš„è·¯å¾„</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">storePath</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>

    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUploadAndCreateThumb</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">FileNotFoundException</span> <span class="o">{</span>
        <span class="nc">File</span> <span class="n">file</span><span class="o">=</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"D:\\my_project\\idea_pro_inuse\\leyouUpload\\logo.jpg"</span><span class="o">);</span>
        <span class="c1">// ä¸Šä¼ å¹¶ä¸”ç”Ÿæˆç¼©ç•¥å›¾</span>
        <span class="nc">StorePath</span> <span class="n">storePath</span><span class="o">=</span><span class="k">this</span><span class="o">.</span><span class="na">storageClient</span><span class="o">.</span><span class="na">uploadImageAndCrtThumbImage</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">),</span><span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span><span class="s">"jpg"</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="c1">// å¸¦åˆ†ç»„çš„è·¯å¾„</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">storePath</span><span class="o">.</span><span class="na">getFullPath</span><span class="o">());</span>
        <span class="c1">// ä¸å¸¦åˆ†ç»„çš„è·¯å¾„</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">storePath</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
        <span class="c1">// è·å–ç¼©ç•¥å›¾è·¯å¾„</span>
        <span class="nc">String</span> <span class="n">path</span><span class="o">=</span><span class="n">thumbImageConfig</span><span class="o">.</span><span class="na">getThumbImagePath</span><span class="o">(</span><span class="n">storePath</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="æµ‹è¯•æ•ˆæœ">æµ‹è¯•æ•ˆæœ</h4>

<blockquote>
  <p>group1/M01/00/00/rBKowFx2JGWADBRMAACARrBGE7w855.jpg
M01/00/00/rBKowFx2JGWADBRMAACARrBGE7w855.jpg</p>
</blockquote>

<h4 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h4>

<ul>
  <li>
    <p>æ”¹åŠ¨ä»¥ä¸Šé…ç½®æ–‡ä»¶å½“ä¸­çš„serveræœåŠ¡å™¨åœ°å€</p>
  </li>
  <li>
    <p>å¼€æ”¾21222å’Œ23000ä¸¤ä¸ªç«¯å£</p>
  </li>
</ul>

<h4 id="å­˜å‚¨æœåŠ¡å™¨storage-serverå®‰è£…å¹¶é…ç½®nginx">å­˜å‚¨æœåŠ¡å™¨ï¼ˆstorage serverï¼‰å®‰è£…å¹¶é…ç½®nginx</h4>

<ul>
  <li>å®‰è£… fastdfs-nginx-module æ¨¡å—</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /root
git clone https://github.com/happyfish100/fastdfs-nginx-module
<span class="nb">cp</span> /root/fastdfs-nginx-module/src/mod_fastdfs.conf /etc/fdfs/
vim /etc/fdfs/mod_fastdfs.conf

<span class="nv">connect_timeout</span><span class="o">=</span>10
<span class="nv">base_path</span><span class="o">=</span>/tmpï¼ˆé»˜è®¤ä¸º/tmpï¼‰
<span class="nv">tracker_server</span><span class="o">=</span>120.78.237.137:22122
<span class="nv">storage_server_port</span><span class="o">=</span>23000ï¼ˆé»˜è®¤é…ç½®ä¸º23000ï¼‰
url_have_group_name <span class="o">=</span> <span class="nb">true
</span><span class="nv">store_path_count</span><span class="o">=</span>2 <span class="c"># è®¾ç½®è®¾å¤‡æ•°é‡</span>
<span class="nv">store_path0</span><span class="o">=</span>/data/fdfs/storage/m0
<span class="nv">store_path1</span><span class="o">=</span>/data/fdfs/storage/m1
<span class="nv">group_name</span><span class="o">=</span>group1ï¼ˆé»˜è®¤é…ç½®ä¸ºgroup1ï¼‰
</code></pre></div></div>

<h4 id="å®‰è£…-nginx-ä¾èµ–åº“">å®‰è£… nginx ä¾èµ–åº“</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> <span class="nb">install </span>pcre-devel zlib-devel
yum <span class="nt">-y</span> <span class="nb">install </span>openssl openssl-devel
</code></pre></div></div>

<h4 id="å®‰è£…-nginx">å®‰è£… nginx</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">cd</span> /root 
 wget http://nginx.org/download/nginx-1.8.1.tar.gz 
 <span class="nb">tar </span>xf nginx-1.8.1.tar.gz 
 <span class="nb">cd </span>nginx-1.8.1 
 ./configure <span class="nt">--prefix</span><span class="o">=</span>/application/nginx/ <span class="nt">--add-module</span><span class="o">=</span>../fastdfs-nginx-module/src/ 
 make <span class="o">&amp;&amp;</span> make <span class="nb">install</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /usr/local/fastdfs/conf/http.conf /etc/fdfs/
<span class="nb">cp</span> /usr/local/fastdfs/conf/mime.types /etc/fdfs/
</code></pre></div></div>

<h4 id="é…ç½®-nginx">é…ç½® nginx</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /application/nginx/conf/nginx.conf
</code></pre></div></div>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">user</span> <span class="s">root</span><span class="p">;</span> 
<span class="k">worker_processes</span> <span class="mi">1</span><span class="p">;</span> <span class="k">events</span> <span class="p">{</span>
    <span class="kn">worker_connections</span>  <span class="mi">1024</span><span class="p">;</span>
<span class="p">}</span> 
<span class="k">http</span> <span class="p">{</span>
        <span class="kn">include</span>       <span class="s">mime.types</span><span class="p">;</span>
        <span class="kn">default_type</span>  <span class="nc">application/octet-stream</span><span class="p">;</span>
        <span class="kn">sendfile</span>        <span class="no">on</span><span class="p">;</span>
        <span class="kn">keepalive_timeout</span>  <span class="mi">65</span><span class="p">;</span>
        <span class="kn">server</span> <span class="p">{</span>
            <span class="kn">listen</span>       <span class="mi">8888</span><span class="p">;</span>
            <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>
            <span class="kn">location</span> <span class="p">~</span><span class="sr">/group[0-9]/</span> <span class="p">{</span>
                <span class="kn">ngx_fastdfs_module</span><span class="p">;</span>
            <span class="p">}</span> <span class="kn">error_page</span> <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="n">/50x.html</span><span class="p">;</span> <span class="kn">location</span> <span class="p">=</span> <span class="n">/50x.html</span> <span class="p">{</span>
            <span class="kn">root</span>   <span class="s">html</span><span class="p">;</span>
            <span class="p">}</span> 
        <span class="p">}</span> 
    <span class="p">}</span>
</code></pre></div></div>

<h4 id="å¯åŠ¨-nginx">å¯åŠ¨ nginx</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /application/nginx/sbin/nginx /etc/init.d/
/etc/init.d/nginx

ss <span class="nt">-lntup</span>|grep 8888
tcp LISTEN 0 128 :8888 :<span class="k">*</span> <span class="nb">users</span>:<span class="o">((</span>â€œnginxâ€,7308,6<span class="o">)</span>,<span class="o">(</span>â€œnginxâ€,7309,6<span class="o">))</span>

</code></pre></div></div>

<h4 id="å¼€å¯ç«¯å£">å¼€å¯ç«¯å£</h4>

<p>å¼€å¯8888ç«¯å£</p>

<h4 id="è¿œç¨‹è®¿é—®">è¿œç¨‹è®¿é—®</h4>

<blockquote>
  <p>http://120.78.237.137:8888/group1/M01/00/00/rBKowFx2JGWADBRMAACARrBGE7w855.jpg</p>
</blockquote>

<p><img src="http://image.augustrush8.com/images/fastdfsTest.png" alt="" /></p>
:ET